{% extends "base.html" %}

{% block title %}Scan Food{% endblock %}

{% block content %}
<div class="container" style="max-width:720px">
  <div class="d-flex align-items-center gap-2 mb-3">
    <div style="font-size:28px">üçé</div>
    <div>
      <h1 class="mb-0">Scan Food</h1>
      <div class="text-muted small">Take a photo and we‚Äôll estimate calories + macros.</div>
    </div>
  </div>

  <div class="alert alert-info small mb-3">
    <div class="fw-semibold">Tip</div>
    Center the food, fill the frame, and use good lighting for best results.
  </div>

  <div class="card shadow-sm border-0 mb-3">
    <div class="card-body">
      <!-- Hidden inputs so iPhone Safari opens the native camera / photo picker -->
      <input id="food_camera" type="file" accept="image/*" capture="environment" style="display:none" />
      <input id="food_upload" type="file" accept="image/*" style="display:none" />

      <div id="previewWrap" class="ratio ratio-1x1 bg-dark rounded d-flex align-items-center justify-content-center" style="overflow:hidden">
        <img id="previewImg" alt="Food preview" style="display:none; width:100%; height:100%; object-fit:cover" />
        <div id="previewPlaceholder" class="text-center text-white-50">
          <div style="font-size:46px">üì∑</div>
          <div class="small">Your photo will appear here</div>
        </div>
      </div>

      <div class="d-flex gap-2 mt-3">
        <button id="btnTake" class="btn btn-success flex-fill"><i class="bi bi-camera"></i> Take Photo</button>
        <button id="btnUpload" class="btn btn-outline-primary flex-fill"><i class="bi bi-upload"></i> Upload Photo</button>
      </div>

      <div id="status" class="mt-3" style="display:none">
        <div class="d-flex align-items-center gap-2">
          <div class="spinner-border" role="status" aria-label="loading"></div>
          <div class="fw-semibold">Analyzing food‚Ä¶</div>
        </div>
      </div>

      <div id="result" class="mt-3" style="display:none"></div>
    </div>
  </div>

  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <div class="fw-semibold mb-2"><i class="bi bi-lightbulb"></i> Tips for best results</div>
      <ul class="mb-0">
        <li>Take photos in good lighting</li>
        <li>Fill the frame with the food</li>
        <li>Avoid shadows and reflections</li>
        <li>For multiple items, scan them separately</li>
        <li>You can adjust serving size after scanning</li>
      </ul>
    </div>
  </div>
</div>

<script>
(() => {
  const cameraInput = document.getElementById('food_camera');
  const uploadInput = document.getElementById('food_upload');
  const btnTake = document.getElementById('btnTake');
  const btnUpload = document.getElementById('btnUpload');
  const previewImg = document.getElementById('previewImg');
  const previewPlaceholder = document.getElementById('previewPlaceholder');
  const status = document.getElementById('status');
  const result = document.getElementById('result');

  function setBusy(isBusy) {
    btnTake.disabled = isBusy;
    btnUpload.disabled = isBusy;
    status.style.display = isBusy ? 'block' : 'none';
  }

  function showPreview(file) {
    const url = URL.createObjectURL(file);
    previewImg.src = url;
    previewImg.style.display = 'block';
    previewPlaceholder.style.display = 'none';
  }

  function renderResult(data) {
    const label = data?.item || data?.name || data?.food || 'Food';
    const kcal = data?.calories ?? data?.kcal;
    const p = data?.protein;
    const c = data?.carbs;
    const f = data?.fat;

    let html = `<div class="alert alert-success mb-2"><div class="fw-semibold">Detected:</div>${label}</div>`;
    html += `<div class="card"><div class="card-body p-3">`;
    html += `<div class="row text-center">`;
    html += `<div class="col"><div class="text-muted small">Calories</div><div class="fw-semibold">${kcal ?? '‚Äî'}</div></div>`;
    html += `<div class="col"><div class="text-muted small">Protein</div><div class="fw-semibold">${p ?? '‚Äî'}</div></div>`;
    html += `<div class="col"><div class="text-muted small">Carbs</div><div class="fw-semibold">${c ?? '‚Äî'}</div></div>`;
    html += `<div class="col"><div class="text-muted small">Fat</div><div class="fw-semibold">${f ?? '‚Äî'}</div></div>`;
    html += `</div></div></div>`;

    result.innerHTML = html;
    result.style.display = 'block';
  }

  async function analyze(file) {
    setBusy(true);
    result.style.display = 'none';

    try {
      showPreview(file);
      const fd = new FormData();
      // Backend expects field name "photo" (matches /api/food-photo-identify)
      fd.append('photo', file, file.name || 'food.jpg');

      const resp = await fetch('{{ url_for("api_food_photo_identify") }}', { method: 'POST', body: fd });
      const data = await resp.json().catch(() => ({}));

      if (!resp.ok || data?.ok === false) {
        const msg = data?.error || `Food detection failed (${resp.status})`;
        alert('Error analyzing food: ' + msg);
        return;
      }

      renderResult(data);
    } catch (err) {
      console.error(err);
      alert('Error analyzing food: ' + (err?.message || err));
    } finally {
      setBusy(false);
    }
  }

  btnTake.addEventListener('click', (e) => {
    e.preventDefault();
    cameraInput.value = '';
    cameraInput.click();
  });

  btnUpload.addEventListener('click', (e) => {
    e.preventDefault();
    uploadInput.value = '';
    uploadInput.click();
  });

  cameraInput.addEventListener('change', () => {
    const file = cameraInput.files && cameraInput.files[0];
    if (file) analyze(file);
  });

  uploadInput.addEventListener('change', () => {
    const file = uploadInput.files && uploadInput.files[0];
    if (file) analyze(file);
  });
})();
</script>
{% endblock %}
