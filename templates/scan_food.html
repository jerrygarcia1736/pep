
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ title or "Scan Food" }}</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:18px;max-width:720px}
    h1{font-size:20px;margin:0 0 10px}
    .tabs{display:flex;gap:8px;margin:12px 0}
    .tab{border:1px solid #ccc;border-radius:10px;padding:8px 10px;background:#fff;cursor:pointer}
    .tab.active{border-color:#111}
    .card{border:1px solid #ddd;border-radius:14px;padding:12px;margin-top:10px}
    .hint{color:#555;font-size:13px;margin:8px 0 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{padding:10px 12px;border:1px solid #111;background:#111;color:#fff;border-radius:12px;cursor:pointer}
    button.secondary{background:#fff;color:#111}
    button:disabled{opacity:.55;cursor:not-allowed}
    textarea{width:100%;min-height:110px;margin-top:10px;font-family:ui-monospace,Menlo,monospace}
    .pred{display:flex;justify-content:space-between;gap:10px;padding:8px 10px;border:1px solid #eee;border-radius:12px;margin:8px 0;cursor:pointer}
    .pred:hover{border-color:#bbb}
    .small{font-size:12px;color:#666}
    .status{margin-top:10px;color:#444}
    img.preview{max-width:100%;border-radius:12px;border:1px solid #eee}
    .note{font-size:12px;color:#666;line-height:1.4}
  </style>
</head>
<body>
<h1>{{ title or "Scan Food" }}</h1>
<div class="note">
  Choose a scan mode:
  <ul>
    <li><b>Photo (AI Guess)</b>: take a picture of the food (e.g., an apple) and get best-guess labels.</li>
    <li><b>Text (OCR)</b>: take a picture of a receipt/label and extract text.</li>
  </ul>
  Always confirm before savingâ€”these are suggestions.
</div>

<div class="tabs">
  <button id="tab-photo" class="tab active" type="button">Photo (AI Guess)</button>
  <button id="tab-ocr" class="tab" type="button">Text (OCR)</button>
</div>

<div id="panel-photo" class="card">
  <div class="row">
    <input id="foodPhoto" type="file" accept="image/*" capture="environment"/>
    <button id="btnClassify" type="button">Analyze Photo</button>
    <button id="btnClearPhoto" class="secondary" type="button">Clear</button>
  </div>
  <div class="hint">Tip: center the food, fill most of the frame, and use bright light.</div>
  <div id="photoStatus" class="status"></div>
  <div id="photoPreviewWrap" style="margin-top:10px;display:none;">
    <img id="photoPreview" class="preview" alt="preview"/>
  </div>
  <div id="predictions" style="margin-top:12px;"></div>
</div>

<div id="panel-ocr" class="card" style="display:none;">
  <div class="row">
    <input id="imageInput" type="file" accept="image/*" capture="environment"/>
    <button id="btnOcr" type="button">Scan Text</button>
    <button id="btnClearOcr" class="secondary" type="button">Clear</button>
  </div>
  <div class="hint">Best for receipts, labels, or handwritten notes about what you ate.</div>
  <div id="ocrStatus" class="status"></div>
  <textarea id="ocrText" placeholder="OCR results will appear here..."></textarea>
  <div class="row" style="margin-top:10px;">
    <button id="btnUseOcr" type="button">Use Text in Food Log</button>
  </div>
</div>

<!-- TensorFlow.js + MobileNet (open source) for in-browser classification -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.1/dist/mobilenet.min.js"></script>

<script>
const tabPhoto = document.getElementById('tab-photo');
const tabOcr = document.getElementById('tab-ocr');
const panelPhoto = document.getElementById('panel-photo');
const panelOcr = document.getElementById('panel-ocr');

function setTab(which){
  const photo = (which === 'photo');
  tabPhoto.classList.toggle('active', photo);
  tabOcr.classList.toggle('active', !photo);
  panelPhoto.style.display = photo ? 'block' : 'none';
  panelOcr.style.display = photo ? 'none' : 'block';
}
tabPhoto.addEventListener('click', () => setTab('photo'));
tabOcr.addEventListener('click', () => setTab('ocr'));

const foodPhoto = document.getElementById('foodPhoto');
const btnClassify = document.getElementById('btnClassify');
const btnClearPhoto = document.getElementById('btnClearPhoto');
const photoStatus = document.getElementById('photoStatus');
const photoPreviewWrap = document.getElementById('photoPreviewWrap');
const photoPreview = document.getElementById('photoPreview');
const predictions = document.getElementById('predictions');

let mobilenetModel = null;

foodPhoto.addEventListener('change', () => {
  const file = foodPhoto.files && foodPhoto.files[0];
  predictions.innerHTML = '';
  photoStatus.textContent = '';
  if (!file) { photoPreviewWrap.style.display = 'none'; return; }
  const url = URL.createObjectURL(file);
  photoPreview.src = url;
  photoPreviewWrap.style.display = 'block';
});

btnClearPhoto.addEventListener('click', () => {
  foodPhoto.value = '';
  photoPreviewWrap.style.display = 'none';
  predictions.innerHTML = '';
  photoStatus.textContent = '';
});

async function ensureModel(){
  if (mobilenetModel) return mobilenetModel;
  photoStatus.textContent = 'Loading model...';
  mobilenetModel = await mobilenet.load({version: 2, alpha: 1.0});
  return mobilenetModel;
}

btnClassify.addEventListener('click', async () => {
  const file = foodPhoto.files && foodPhoto.files[0];
  predictions.innerHTML = '';
  if (!file) { photoStatus.textContent = 'Choose a photo first.'; return; }
  btnClassify.disabled = true;
  try{
    await ensureModel();
    photoStatus.textContent = 'Analyzing...';
    await new Promise((res, rej) => {
      if (photoPreview.complete) return res();
      photoPreview.onload = () => res();
      photoPreview.onerror = () => rej(new Error('Could not load image.'));
    });
    const preds = await mobilenetModel.classify(photoPreview, 5);
    if (!preds || preds.length === 0){
      photoStatus.textContent = 'No guesses found. Try a clearer photo.';
      return;
    }
    photoStatus.textContent = 'Tap a guess to log it:';
    preds.forEach(p => {
      const label = (p.className || '').split(',')[0].trim();
      const pct = Math.round((p.probability || 0) * 100);
      const div = document.createElement('div');
      div.className = 'pred';
      div.innerHTML = `<div><b>${label}</b><div class="small">${p.className}</div></div><div>${pct}%</div>`;
      div.addEventListener('click', () => {
        window.location.href = '/log-food?q=' + encodeURIComponent(label);
      });
      predictions.appendChild(div);
    });
  }catch(e){
    photoStatus.textContent = 'Error: ' + e.message;
  }finally{
    btnClassify.disabled = false;
  }
});

// --- OCR panel logic (server-side OCR) ---
const imageInput = document.getElementById('imageInput');
const btnOcr = document.getElementById('btnOcr');
const btnClearOcr = document.getElementById('btnClearOcr');
const ocrStatus = document.getElementById('ocrStatus');
const ocrText = document.getElementById('ocrText');
const btnUseOcr = document.getElementById('btnUseOcr');

btnClearOcr.addEventListener('click', () => {
  imageInput.value = '';
  ocrText.value = '';
  ocrStatus.textContent = '';
});

btnUseOcr.addEventListener('click', () => {
  const q = (ocrText.value || '').trim();
  if (!q) { ocrStatus.textContent = 'Scan text first.'; return; }
  window.location.href = '/log-food?q=' + encodeURIComponent(q);
});

btnOcr.addEventListener('click', async () => {
  const file = imageInput.files && imageInput.files[0];
  if (!file) { ocrStatus.textContent = 'Choose a photo first.'; return; }
  btnOcr.disabled = true;
  try{
    ocrStatus.textContent = 'Uploading...';
    const form = new FormData();
    form.append('image', file);
    const res = await fetch('{{ api_endpoint }}', { method:'POST', body: form });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'OCR failed');
    ocrText.value = data.raw_text || '';
    ocrStatus.textContent = 'Done.';
  }catch(e){
    ocrStatus.textContent = 'Error: ' + e.message;
  }finally{
    btnOcr.disabled = false;
  }
});
</script>
</body>
</html>

