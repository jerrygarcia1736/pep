{% extends "base.html" %}
{% block title %}Reconstitution Calculator{% endblock %}

{% block content %}
<div class="d-flex align-items-center gap-2 mb-4">
  <div style="font-size:28px">ðŸ§®</div>
  <div>
    <h1 class="mb-0">Reconstitution Calculator</h1>
  </div>
</div>

<div class="row g-4">
  <div class="col-12 col-lg-6">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-info text-white">
        <div class="fw-semibold">Calculate Dosage</div>
      </div>
      <div class="card-body">
        <form id="calcForm" method="post" action="{{ url_for('peptide_calculator') }}">
          <input type="hidden" name="action" id="action" value="">

          <div class="mb-3">
            <label class="form-label">Peptide</label>
            <select class="form-select" name="peptide_id" id="peptide_id" required>
              <option value="">Select a peptide...</option>
              {% for p in peptides %}
                <option value="{{ p.id }}">{{ p.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Vial Size (mg)</label>
            <input class="form-control" type="number" step="0.1" min="0" name="vial_size_mg" id="vial_size_mg" value="5" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Bacteriostatic Water (ml)</label>
            <input class="form-control" type="number" step="0.1" min="0" name="water_ml" id="water_ml" value="2" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Desired Dose (mcg)</label>
            <input class="form-control" type="number" step="1" min="0" name="desired_dose_mcg" id="desired_dose_mcg" value="250" required>
          </div>

          <div class="mb-4">
            <label class="form-label">Injections Per Day</label>
            <input class="form-control" type="number" step="1" min="1" name="injections_per_day" id="injections_per_day" value="2" required>
          </div>

          <button type="button" class="btn btn-info w-100 text-white" onclick="calculate()">
            ðŸ§® Calculate
          </button>

          <hr class="my-4">

          <div class="mb-2 fw-semibold">Save as Protocol</div>
          <div class="mb-3">
            <label class="form-label">Protocol Name</label>
            <input class="form-control" type="text" name="protocol_name" id="protocol_name" placeholder="e.g., BPC-157 Recovery">
          </div>

          <button type="submit" class="btn btn-primary w-100" onclick="document.getElementById('action').value='save_protocol';">
            ðŸ’¾ Save Protocol
          </button>

          <div class="form-text mt-2">
            Saving creates a protocol using the selected peptide, desired dose (mcg), and injections/day.
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body d-flex flex-column justify-content-center align-items-center text-center" id="resultsCard">
        <div style="font-size:56px; opacity:.7">ðŸ§®</div>
        <div class="text-muted mt-2">Enter vial details to calculate reconstitution</div>
      </div>
    </div>
  </div>
</div>

<script>
function calculate() {
  const vialMg = parseFloat(document.getElementById('vial_size_mg').value || '0');
  const waterMl = parseFloat(document.getElementById('water_ml').value || '0');
  const doseMcg = parseFloat(document.getElementById('desired_dose_mcg').value || '0');
  const perDay = parseInt(document.getElementById('injections_per_day').value || '1', 10);

  if (!vialMg || !waterMl || !doseMcg) {
    return;
  }

  // Total mcg in vial
  const totalMcg = vialMg * 1000.0;
  // mcg per ml
  const mcgPerMl = totalMcg / waterMl;
  // ml per injection
  const mlPerInjection = doseMcg / mcgPerMl;
  // insulin units per injection (U-100) => 1 mL = 100 units
  const unitsPerInjection = mlPerInjection * 100.0;

  const injectionsPerVial = totalMcg / doseMcg;
  const daysPerVial = injectionsPerVial / perDay;

  const results = document.getElementById('resultsCard');
  results.innerHTML = `
    <div class="w-100">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="fw-semibold">Results</div>
      </div>

      <div class="alert alert-info text-start">
        <div><strong>Concentration:</strong> ${mcgPerMl.toFixed(1)} mcg / mL</div>
        <div><strong>Per injection:</strong> ${mlPerInjection.toFixed(3)} mL (~${unitsPerInjection.toFixed(1)} units on U-100)</div>
      </div>

      <div class="card border-0 bg-light">
        <div class="card-body text-start">
          <div><strong>Total per vial:</strong> ${vialMg.toFixed(1)} mg (${totalMcg.toFixed(0)} mcg)</div>
          <div><strong>Injections per vial:</strong> ${injectionsPerVial.toFixed(1)}</div>
          <div><strong>Estimated days per vial:</strong> ${daysPerVial.toFixed(1)} days</div>
        </div>
      </div>

      <div class="text-muted small mt-3">
        Educational calculation only â€” confirm with a medical professional.
      </div>
    </div>
  `;
}
</script>
{% endblock %}
