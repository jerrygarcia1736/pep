<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>üíâ Scan Peptides - PeptideTracker.ai</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0 auto;
      max-width: 800px;
      padding: 20px;
      background: #f8f9fa;
      line-height: 1.6;
    }
    
    h1 {
      font-size: 28px;
      margin: 0 0 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #111;
    }
    
    .subtitle {
      color: #666;
      font-size: 15px;
      margin: 0 0 20px;
    }
    
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,.08);
      margin-bottom: 20px;
    }
    
    .alert {
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      font-size: 14px;
    }
    
    .alert-info {
      background: #e3f2fd;
      border: 1px solid #90caf9;
      color: #0d47a1;
    }
    
    .alert-warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
    }
    
    .alert-success {
      background: #d4edda;
      border: 1px solid #28a745;
      color: #155724;
    }
    
    .alert-danger {
      background: #f8d7da;
      border: 1px solid #dc3545;
      color: #721c24;
    }
    
    .button-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 16px 0;
    }
    
    button {
      padding: 12px 20px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: #4f46e5;
      color: white;
      flex: 1;
      justify-content: center;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #4338ca;
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: white;
      color: #4f46e5;
      border: 2px solid #4f46e5;
      flex: 1;
      justify-content: center;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: #f5f5f5;
    }
    
    .btn-clear {
      background: #6c757d;
      color: white;
      padding: 8px 16px;
      font-size: 14px;
    }
    
    .btn-clear:hover:not(:disabled) {
      background: #5a6268;
    }
    
    input[type="file"] {
      display: none;
    }
    
    .preview-container {
      margin: 16px 0;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #e0e0e0;
      background: #fafafa;
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .preview-container img {
      max-width: 100%;
      height: auto;
      display: block;
    }
    
    .preview-placeholder {
      text-align: center;
      color: #999;
      padding: 40px 20px;
    }
    
    .preview-placeholder-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-family: "Courier New", monospace;
      font-size: 14px;
      resize: vertical;
      margin: 12px 0;
    }
    
    textarea:focus {
      outline: none;
      border-color: #4f46e5;
    }
    
    .section-title {
      font-weight: 700;
      font-size: 16px;
      margin: 16px 0 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 12px 0;
    }
    
    .chip {
      padding: 10px 16px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .chip:hover {
      border-color: #4f46e5;
      background: #f8f7ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
    }
    
    .chip-name {
      font-weight: 700;
    }
    
    .chip-confidence {
      color: #4f46e5;
      font-weight: 600;
      font-size: 13px;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4f46e5;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .status {
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      margin: 12px 0;
      display: none;
    }
    
    .status.loading {
      background: #fff3cd;
      color: #856404;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      display: block;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      display: block;
    }
    
    .save-section {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 12px;
      margin-top: 16px;
      display: none;
    }
    
    .form-group {
      margin-bottom: 12px;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 6px;
      color: #555;
    }
    
    select, input[type="number"] {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }
    
    select:focus, input[type="number"]:focus {
      outline: none;
      border-color: #4f46e5;
    }
    
    .save-status {
      margin-top: 10px;
      font-size: 14px;
      font-weight: 600;
    }
    
    ul {
      margin: 8px 0;
      padding-left: 20px;
    }
    
    ul li {
      margin: 4px 0;
      font-size: 14px;
    }
    
    strong {
      font-weight: 600;
    }
    
    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #4f46e5;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
    }
    
    .back-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <a href="/dashboard" class="back-link">‚Üê Back to Dashboard</a>
  
  <h1>üíâ Scan Peptides</h1>
  <p class="subtitle">Take a photo of your peptide vial label (printed or handwritten). We'll extract the text and match it to known peptides.</p>

  <div class="card">
    <!-- Handwriting Tips -->
    <div class="alert alert-info">
      <strong>üìù For Handwritten Labels:</strong>
      <ul>
        <li><strong>Use thick marker</strong> (Sharpie works best)</li>
        <li><strong>Print clearly</strong> - avoid cursive</li>
        <li><strong>Write larger</strong> than normal</li>
        <li><strong>Good lighting</strong> is crucial</li>
        <li><strong>Hold camera steady</strong> and fill the frame</li>
      </ul>
    </div>

    <!-- Hidden file inputs -->
    <input id="cameraInput" type="file" accept="image/*" capture="environment" />
    <input id="fileInput" type="file" accept="image/*" />
    
    <!-- Action Buttons -->
    <div class="button-row">
      <button id="btnCamera" class="btn-primary" type="button">
        üì∏ Take Photo
      </button>
      <button id="btnFile" class="btn-secondary" type="button">
        üìÅ Choose File
      </button>
      <button id="btnClear" class="btn-clear" type="button">
        üóëÔ∏è Clear
      </button>
    </div>

    <!-- Status Messages -->
    <div id="status" class="status"></div>

    <!-- Preview -->
    <div id="previewContainer" class="preview-container" style="display:none;">
      <img id="previewImg" alt="Label preview" />
    </div>
    <div id="previewPlaceholder" class="preview-container">
      <div class="preview-placeholder">
        <div class="preview-placeholder-icon">üì∑</div>
        <div>Take or upload a photo to begin</div>
      </div>
    </div>

    <!-- Extracted Text -->
    <div class="section-title">üìÑ Extracted Text</div>
    <textarea id="ocrText" placeholder="OCR results will appear here..."></textarea>
    <div class="alert alert-warning" style="font-size: 13px;">
      <strong>üí° Tip:</strong> You can manually edit the text above if OCR missed anything
    </div>

    <!-- Peptide Matches -->
    <div class="section-title">üíä Peptide Matches</div>
    <div id="candidates" class="chips"></div>
    <div id="noCandidates" style="display:none; color:#999; font-style:italic; margin: 12px 0;">
      No matches found. Try a clearer photo or check the extracted text above.
    </div>

    <!-- Save Section -->
    <div id="saveSection" class="save-section">
      <div class="section-title">üíæ Save as Vial (Optional)</div>
      
      <div class="form-group">
        <label class="form-label">Peptide</label>
        <select id="peptideSelect"></select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Vial Size (mg)</label>
        <input id="vialMg" type="number" step="0.1" placeholder="e.g., 5 or 10" />
      </div>
      <div class="form-group">
        <label class="form-label">Number of Vials (optional)</label>
        <input id="numVials" type="number" min="1" step="1" value="1" />
      </div>
      
      
      <button id="saveVialBtn" class="btn-primary" type="button">
        üíæ Save to Vials
      </button>
      
      <div id="saveStatus" class="save-status"></div>
    </div>
  </div>

  <script>
  (() => {
    // DOM elements
    const cameraInput = document.getElementById('cameraInput');
    const fileInput = document.getElementById('fileInput');
    const btnCamera = document.getElementById('btnCamera');
    const btnFile = document.getElementById('btnFile');
    const btnClear = document.getElementById('btnClear');
    const status = document.getElementById('status');
    const previewContainer = document.getElementById('previewContainer');
    const previewPlaceholder = document.getElementById('previewPlaceholder');
    const previewImg = document.getElementById('previewImg');
    const ocrText = document.getElementById('ocrText');
    const candidates = document.getElementById('candidates');
    const noCandidates = document.getElementById('noCandidates');
    const saveSection = document.getElementById('saveSection');
    const peptideSelect = document.getElementById('peptideSelect');
    const vialMg = document.getElementById('vialMg');
    const saveVialBtn = document.getElementById('saveVialBtn');
    const saveStatus = document.getElementById('saveStatus');

    // State
    let currentMatches = [];
    let lastFingerprint = null;

    // Show status
    function showStatus(message, type = 'loading') {
      status.className = `status ${type}`;
      if (type === 'loading') {
        status.innerHTML = `<span class="spinner"></span>${message}`;
      } else {
        status.textContent = message;
      }
    }

    // Hide status
    function hideStatus() {
      status.style.display = 'none';
    }

    // Set buttons disabled state
    function setButtonsDisabled(disabled) {
      btnCamera.disabled = disabled;
      btnFile.disabled = disabled;
      btnClear.disabled = disabled;
    }

    // Show preview
    function showPreview(file) {
      const url = URL.createObjectURL(file);
      previewImg.src = url;
      previewContainer.style.display = 'flex';
      previewPlaceholder.style.display = 'none';
    }

    // Clear all
    function clearAll() {
      cameraInput.value = '';
      fileInput.value = '';
      previewContainer.style.display = 'none';
      previewPlaceholder.style.display = 'flex';
      previewImg.src = '';
      ocrText.value = '';
      candidates.innerHTML = '';
      noCandidates.style.display = 'none';
      saveSection.style.display = 'none';
      saveStatus.textContent = '';
      currentMatches = [];
      hideStatus();
    }

    // Render candidates
    function renderCandidates(matches) {
      candidates.innerHTML = '';
      peptideSelect.innerHTML = '';
      currentMatches = matches || [];

      if (currentMatches.length === 0) {
        noCandidates.style.display = 'block';
        saveSection.style.display = 'none';
        return;
      }

      noCandidates.style.display = 'none';

      currentMatches.forEach((match, index) => {
        const name = match.name || match;
        const confidence = match.confidence || 0;
        
        // Create chip button
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.innerHTML = `
          <span class="chip-name">${name}</span>
          <span class="chip-confidence">${Math.round(confidence * 100)}%</span>
        `;
        chip.addEventListener('click', () => copyToClipboard(name));
        candidates.appendChild(chip);

        // Add to select dropdown
        const option = document.createElement('option');
        option.value = name;
        option.textContent = `${name} (${Math.round(confidence * 100)}%)`;
        if (index === 0) option.selected = true;
        peptideSelect.appendChild(option);
      });

      saveSection.style.display = 'block';
    }

    // Copy to clipboard
    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        showStatus(`‚úÖ Copied: ${text}`, 'success');
        setTimeout(hideStatus, 3000);
      } catch (e) {
        showStatus('‚ùå Copy failed. Please select and copy manually.', 'error');
      }
    }

    // Scan image
    async function scanImage(file) {
      if (!file) return;

      setButtonsDisabled(true);
      showStatus('Scanning label...', 'loading');
      ocrText.value = '';
      candidates.innerHTML = '';
      noCandidates.style.display = 'none';
      saveSection.style.display = 'none';

      try {
        showPreview(file);

        const formData = new FormData();
        formData.append('image', file);

        const response = await fetch('/api/scan-peptide-label', {
          method: 'POST',
          body: formData
        });

        const text = await response.text();
        let data = null;
        try { data = JSON.parse(text); } catch (e) {}

        if (!response.ok) {
          throw new Error(data?.error || text || `Scan failed (${response.status})`);
        }

        // Display extracted text
        ocrText.value = data.raw_text || data.text || '';
        lastFingerprint = data.fingerprint || null;

        // Display matches
        const matches = data.matches || [];
        renderCandidates(matches);

        if (matches.length > 0) {
          showStatus(`‚úÖ Found ${matches.length} matches! Tap to copy.`, 'success');
        } else {
          showStatus('‚ö†Ô∏è No peptide matches found. Try a clearer photo or edit the text above.', 'error');
        }
      } catch (error) {
        console.error('Scan error:', error);
        showStatus(`‚ùå Error: ${error.message || 'Scan failed'}`, 'error');
      } finally {
        setButtonsDisabled(false);
      }
    }

    // Save vial
    async function saveVial() {
      const peptideName = peptideSelect.value;
      const mgAmount = parseFloat(vialMg.value) || 0;
      const numVials = Math.max(1, Math.min(50, parseInt((document.getElementById('numVials')?.value || '1'), 10) || 1));

      if (!peptideName) {
        saveStatus.textContent = '‚ùå Please select a peptide';
        return;
      }

      saveVialBtn.disabled = true;
      saveStatus.textContent = 'üíæ Saving...';

      try {
        const payload = {
          peptide_name: peptideName,
          vial_size_mg: mgAmount,
          num_vials: numVials,
          raw_text: ocrText.value || '',
          notes: `Scanned from label`
        };

        // Save correction so this exact label is recognized next time
        try {
          const remember = document.getElementById('rememberPeptide');
          if (remember && remember.checked && lastFingerprint) {
            await fetch('/api/scan-correction', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                scan_type: 'peptide',
                fingerprint: lastFingerprint,
                corrected: peptideName,
                original: (ocrText.value || '').slice(0, 350)
              })
            });
          }
        } catch (e) {
          console.warn('Could not save correction:', e);
        }


        const response = await fetch('/api/save-scanned-peptide', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const text = await response.text();
        let data = null;
        try { data = JSON.parse(text); } catch (e) {}

        if (!response.ok) {
          throw new Error(data?.error || text || 'Failed to save');
        }

        const vialId = data.vial_id || 'new';
        saveStatus.textContent = `‚úÖ Saved! (Vial #${vialId})`;
        
        // Clear form after successful save
        setTimeout(() => {
          vialMg.value = '';
          saveStatus.textContent = '';
        }, 3000);
      } catch (error) {
        console.error('Save error:', error);
        saveStatus.textContent = `‚ùå ${error.message || 'Save failed'}`;
      } finally {
        saveVialBtn.disabled = false;
      }
    }

    // Event listeners
    btnCamera.addEventListener('click', () => {
      cameraInput.value = '';
      cameraInput.click();
    });

    btnFile.addEventListener('click', () => {
      fileInput.value = '';
      fileInput.click();
    });

    btnClear.addEventListener('click', clearAll);

    cameraInput.addEventListener('change', () => {
      const file = cameraInput.files?.[0];
      if (file) {
        console.log('Camera selected:', file.name, file.size, 'bytes');
        scanImage(file);
      }
    });

    fileInput.addEventListener('change', () => {
      const file = fileInput.files?.[0];
      if (file) {
        console.log('File selected:', file.name, file.size, 'bytes');
        scanImage(file);
      }
    });

    saveVialBtn.addEventListener('click', saveVial);

    console.log('Scan Peptides page loaded successfully');
  })();
  </script>
</body>
</html>