{% extends "base.html" %}

{% block title %}Peptide Library - Peptide Tracker{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="mb-0"><i class="bi bi-list-ul"></i> Peptide Library</h1>
    <p class="text-muted small mb-0 mt-1">Select peptides to compare side-by-side</p>
  </div>
  <button id="compareBtn" class="btn btn-primary" onclick="comparePeptides()" disabled>
    <i class="bi bi-bar-chart-fill"></i> Compare <span id="compareCount" class="badge bg-light text-dark">0</span>
  </button>
</div>

{% if peptides %}
<div class="row g-4">
  {% for peptide in peptides %}
  <div class="col-12 col-sm-6 col-md-4 col-lg-3">
    <a href="{{ url_for('peptide_detail', peptide_id=peptide.id) }}" class="text-decoration-none">
      <div class="card h-100 card-hover shadow-sm">
        <!-- Peptide Image -->
        <div class="ratio ratio-1x1 bg-light">
          {% if peptide.image_filename %}
            <img src="{{ url_for('static', filename='img/peptides/' + peptide.image_filename) }}" 
                 alt="{{ peptide.name }}" 
                 class="pep-img"
                 loading="lazy"
                 onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?><svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;400&quot; height=&quot;400&quot; viewBox=&quot;0 0 400 400&quot;><rect width=&quot;400&quot; height=&quot;400&quot; fill=&quot;%23f1f3f5&quot;/><text x=&quot;50%&quot; y=&quot;50%&quot; dominant-baseline=&quot;middle&quot; text-anchor=&quot;middle&quot; fill=&quot;%236c757d&quot; font-family=&quot;Arial&quot; font-size=&quot;18&quot;>{{ peptide.name }}</text></svg>';">
          {% else %}
            <div class="d-flex align-items-center justify-content-center bg-gradient h-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
              <div class="text-center text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M8 2v4"/>
                  <path d="M16 2v4"/>
                  <rect x="6" y="4" width="12" height="18" rx="2"/>
                  <path d="M9 9h6"/>
                  <path d="M9 13h6"/>
                  <path d="M9 17h6"/>
                </svg>
                <div class="mt-2 small fw-semibold">{{ peptide.name }}</div>
              </div>
            </div>
          {% endif %}
        </div>

        <!-- Peptide Info -->
        <div class="card-body">
          <h5 class="card-title mb-1">{{ peptide.name }}</h5>
          {% if peptide.common_name %}
          <div class="text-muted small mb-2">{{ peptide.common_name }}</div>
          {% endif %}

          {% if peptide.primary_benefits %}
          <p class="card-text small text-muted mb-2" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
            {{ peptide.primary_benefits }}
          </p>
          {% endif %}

          <!-- Tags/Badges -->
          <div class="d-flex flex-wrap gap-1 mb-2">
            {% if peptide.primary_route %}
            <span class="badge bg-primary badge-pill">{{ peptide.primary_route.value }}</span>
            {% endif %}
            {% if peptide.typical_dose_min %}
            <span class="badge bg-secondary badge-pill">{{ peptide.typical_dose_min }}-{{ peptide.typical_dose_max or peptide.typical_dose_min }} mcg</span>
            {% endif %}
          </div>
        </div>

        <div class="card-footer bg-transparent border-top-0 pt-0">
          <div class="d-flex justify-content-between align-items-center">
            <div class="form-check">
              <input class="form-check-input compare-checkbox" type="checkbox" value="{{ peptide.id }}" id="compare{{ peptide.id }}">
              <label class="form-check-label small text-muted" for="compare{{ peptide.id }}">
                Compare
              </label>
            </div>
            <span class="text-primary small">
              View Details <i class="bi bi-arrow-right"></i>
            </span>
          </div>
        </div>
      </div>
    </a>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="alert alert-info text-center py-5">
  <i class="bi bi-inbox" style="font-size: 3rem;"></i>
  <h4 class="mt-3">No Peptides Found</h4>
  <p class="mb-0">The peptide database is empty. Contact support to add peptides.</p>
</div>
{% endif %}

{% endblock %}

{% block extra_css %}
<style>
.card-hover {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.card-hover:hover {
  transform: translateY(-5px);
  box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.15) !important;
}
.pep-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Compare functionality
function updateCompareButton() {
  const checkboxes = document.querySelectorAll('.compare-checkbox:checked');
  const count = checkboxes.length;
  const btn = document.getElementById('compareBtn');
  const countBadge = document.getElementById('compareCount');
  
  countBadge.textContent = count;
  
  if (count >= 2 && count <= 6) {
    btn.disabled = false;
    btn.classList.remove('btn-secondary');
    btn.classList.add('btn-primary');
  } else {
    btn.disabled = true;
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-secondary');
  }
}

function comparePeptides() {
  const checkboxes = document.querySelectorAll('.compare-checkbox:checked');
  const ids = Array.from(checkboxes).map(cb => cb.value);
  
  if (ids.length >= 2 && ids.length <= 6) {
    window.location.href = `/compare?ids=${ids.join(',')}`;
  } else {
    alert('Please select 2-6 peptides to compare');
  }
}

// Attach listeners to all checkboxes
document.querySelectorAll('.compare-checkbox').forEach(checkbox => {
  checkbox.addEventListener('change', updateCompareButton);
});

// Prevent card link from triggering when clicking checkbox
document.querySelectorAll('.compare-checkbox').forEach(checkbox => {
  checkbox.addEventListener('click', function(e) {
    e.stopPropagation();
  });
});
</script>
{% endblock %}
