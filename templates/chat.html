{% extends "base.html" %}

{% block title %}Pep AI - Peptide Tracker
<!-- Upgrade Modal -->
<div class="modal fade" id="upgradeModal" tabindex="-1" aria-labelledby="upgradeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="upgradeModalLabel">Free Pep AI limit reached</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        You’ve used your 10 free Pep AI messages. Upgrade to keep using Pep AI.
      </div>
      <div class="modal-footer">
        <a class="btn btn-primary" href="{{ url_for('upgrade') if has_endpoint('upgrade') else '/upgrade' }}">Upgrade</a>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Not now</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
  <h1 class="mb-0">
    <i class="bi bi-chat-dots"></i> Pep AI
  </h1>
  <span class="badge bg-secondary">Educational only</span>
</div>

<div class="alert alert-warning" role="alert">
  <strong>Educational Tool Only:</strong> Pep AI provides general research summaries and math help (e.g., reconstitution).
  It does not provide medical advice. Consult a licensed healthcare professional for medical decisions.
</div>

<div class="card shadow-sm border-0">
  <div class="card-header bg-white d-flex align-items-center justify-content-between">
    <div class="fw-semibold">Chat</div>
    <button class="btn btn-sm btn-outline-secondary" id="clearBtn" type="button">
      <i class="bi bi-trash"></i> Clear
    </button>
  </div>

  <div class="card-body" style="height: 55vh; overflow:auto;" id="chatWindow" aria-live="polite">
    <div class="text-muted small">
      Ask about mechanisms, study summaries, common research ranges, or use Pep AI for calculation help.
    </div>
  </div>

  <div class="card-footer bg-white">
    <form id="chatForm" class="d-flex gap-2">
      <input class="form-control" id="messageInput" placeholder="Type your question..." autocomplete="off" />
      <button class="btn btn-primary" type="submit" id="sendBtn">
        <i class="bi bi-send"></i>
      </button>
    </form>
    <div class="small text-muted mt-2">
      Tip: You can paste a study abstract or ask “summarize the evidence for …”.
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const chatWindow = document.getElementById("chatWindow");
  const form = document.getElementById("chatForm");
  const input = document.getElementById("messageInput");
  const clearBtn = document.getElementById("clearBtn");
  const sendBtn = document.getElementById("sendBtn");

  function el(tag, cls, text){
    const e = document.createElement(tag);
    if (cls) e.className = cls;
    if (text !== undefined) e.textContent = text;
    return e;
  }

  function addBubble(role, text){
    const wrap = el("div", "d-flex mb-3 " + (role === "user" ? "justify-content-end" : "justify-content-start"));
    const bubble = el("div", "p-3 rounded-4 " + (role === "user" ? "bg-primary text-white" : "bg-light border"));
    bubble.style.maxWidth = "85%";
    bubble.style.whiteSpace = "pre-wrap";
    bubble.textContent = text;
    wrap.appendChild(bubble);
    chatWindow.appendChild(wrap);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  function setLoading(isLoading){
    sendBtn.disabled = isLoading;
    input.disabled = isLoading;
    if (isLoading) sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
    else sendBtn.innerHTML = '<i class="bi bi-send"></i>';
  }

  // Load history
  const KEY = "pep_ai_chat_history_v1";
  try{
    const saved = JSON.parse(localStorage.getItem(KEY) || "[]");
    saved.forEach(m => addBubble(m.role, m.text));
  }catch(e){}

  function saveHistory(){
    const bubbles = chatWindow.querySelectorAll(".rounded-4");
    const msgs = [];
    // Skip the first tip text if no messages
    bubbles.forEach(b => {
      const isUser = b.classList.contains("bg-primary");
      msgs.push({ role: isUser ? "user" : "assistant", text: b.textContent });
    });
    localStorage.setItem(KEY, JSON.stringify(msgs.slice(-50)));
  }

  clearBtn.addEventListener("click", () => {
    chatWindow.innerHTML = '<div class="text-muted small">Ask about mechanisms, study summaries, common research ranges, or use Pep AI for calculation help.</div>';
    localStorage.removeItem(KEY);
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const msg = (input.value || "").trim();
    if (!msg) return;

    addBubble("user", msg);
    saveHistory();
    input.value = "";
    setLoading(true);

    try{
      const resp = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: msg })
      });

      const data = await resp.json().catch(() => ({}));

      if (!resp.ok){
        const err = data.error || data.message || ("Request failed (" + resp.status + ")");
        addBubble("assistant", "Sorry — " + err);
        saveHistory();
        setLoading(false);
        return;
      }

      // Accept either {reply: "..."} or {message:"..."} depending on your backend
      const reply = data.reply || data.message || data.content || "";
      addBubble("assistant", reply || "No response received.");
      saveHistory();
    }catch(err){
      addBubble("assistant", "Network error. Please try again.");
      saveHistory();
    }finally{
      setLoading(false);
      input.focus();
    }
  });

})();
</script>
{% endblock %}
