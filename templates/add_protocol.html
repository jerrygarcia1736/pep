{% extends "base.html" %}
{% block title %}Add Protocol{% endblock %}
{% block content %}
<h1 class="mb-4"><i class="bi bi-plus-circle"></i> Add Protocol</h1>

<div class="row">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-body">

        {% if template_data %}
          <div class="alert alert-info">
            <i class="bi bi-lightning-charge me-2"></i>
            Template loaded: <strong>{{ template_data.protocol_name }}</strong>. Review details and save.
          </div>
        {% endif %}

        <form method="POST">
          <div class="mb-3">
            <label for="protocol_name" class="form-label">Protocol name</label>
            <input
              type="text"
              class="form-control"
              id="protocol_name"
              name="protocol_name"
              value="{% if form %}{{ form.get('protocol_name','') }}{% elif prefill %}{{ prefill.protocol_name }}{% endif %}"
              required
            >
          </div>

          <div class="mb-3">
            <label for="peptide_id" class="form-label">Peptide</label>
            <select class="form-select" id="peptide_id" name="peptide_id" required>
              <option value="">Select peptide...</option>
              {% for p in peptides %}
                {% set selected = false %}
                {% if form and form.get('peptide_id') and (form.get('peptide_id')|int == p.id) %}
                  {% set selected = true %}
                {% elif (not form) and template_data and (p.name|lower == template_data.name|lower or p.common_name|lower == template_data.name|lower) %}
                  {% set selected = true %}
                {% endif %}
                <option value="{{ p.id }}" {% if selected %}selected{% endif %}>
                  {{ p.name }}{% if p.common_name %} ({{ p.common_name }}){% endif %}
                </option>
              {% endfor %}
            </select>
            <div class="form-text">Templates select a peptide for you, but you can change it.</div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="dose_mcg" class="form-label">Dose (mcg)</label>
              <input
                type="number"
                step="1"
                class="form-control"
                id="dose_mcg"
                name="dose_mcg"
                value="{% if form %}{{ form.get('dose_mcg','') }}{% endif %}"
              >
              <div class="form-text">Optional — set the dose you plan to use.</div>
            </div>
            <div class="col-md-6 mb-3">
              <label for="frequency_per_day" class="form-label">Frequency (per day)</label>
              <input
                type="number"
                step="0.5"
                class="form-control"
                id="frequency_per_day"
                name="frequency_per_day"
                value="{% if form %}{{ form.get('frequency_per_day','') }}{% endif %}"
              >
              <div class="form-text">Optional — e.g., 1, 2, 0.5, etc.</div>
            </div>
          </div>

          <div class="mb-3">
            <label for="notes" class="form-label">Notes (optional)</label>
            <textarea class="form-control" id="notes" name="notes" rows="4">{% if form %}{{ form.get('notes','') }}{% endif %}</textarea>
          </div>

          <div class="d-grid">
            <button type="submit" class="btn btn-success btn-lg">
              <i class="bi bi-check-circle"></i> Save Protocol
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>
{% endblock %}
